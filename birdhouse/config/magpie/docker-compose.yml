version: "3.4"

x-logging:
  &default-logging
  driver: "json-file"
  options:
    max-size: "50m"
    max-file: "10"

services:
  magpie:
    image: pavics/magpie:${MAGPIE_VERSION}
    container_name: magpie
    ports:
      - "2001:2001"
    environment:
      TWITCHER_PROTECTED_URL: https://${PAVICS_FQDN_PUBLIC}${TWITCHER_PROTECTED_PATH}
      # target directories to allow loading multiple config files of corresponding category
      # each compose override should volume mount its files inside the matching directories
      # (note: DO NOT use 'MAGPIE_CONFIG_PATH' that would disable multi-config loading capability)
      MAGPIE_PROVIDERS_CONFIG_PATH: "/opt/local/src/magpie/config/providers"
      MAGPIE_PERMISSIONS_CONFIG_PATH: "/opt/local/src/magpie/config/permissions"
      MAGPIE_WEBHOOKS_CONFIG_PATH: "/opt/local/src/magpie/config/webhooks"
      MAGPIE_POSTGRES_HOST: postgres-magpie
      MAGPIE_PORT: 2001
      FORWARDED_ALLOW_IPS: "*"
    env_file:
      - ./config/postgres-magpie/credentials.env
    depends_on:
      - postgres-magpie
    links:
      - postgres-magpie
    volumes:
      - ./config/postgres-magpie/credentials.env:/opt/local/src/magpie/env/postgres.env
      - ./config/magpie/providers.cfg:/opt/local/src/magpie/config/providers/providers.cfg
      - ./config/magpie/permissions.cfg:/opt/local/src/magpie/config/permissions/permissions.cfg
      - ./config/magpie/magpie.ini:/opt/local/src/magpie/config/magpie.ini
    restart: always
    logging: *default-logging
