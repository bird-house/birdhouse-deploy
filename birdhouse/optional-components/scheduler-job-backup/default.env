# image used to run docker commands in the scheduler
export SCHEDULER_JOB_BACKUP_DOCKER_IMAGE='${DOCKER_CLI_IMAGE}'
# image used to copy files from one location to another
export SCHEDULER_JOB_BACKUP_COPY_FILE_IMAGE='${BASH_IMAGE}'
# image used to run curl when backups require a RESTful API step
export SCHEDULER_JOB_BACKUP_CURL_IMAGE='${CURL_IMAGE}'
# image used to run restic
export SCHEDULER_JOB_BACKUP_RESTIC_IMAGE='restic/restic:0.18.0'

# prefix used to name all backup jobs that store data from services
export SCHEDULER_JOB_BACKUP_PREFIX='backup_'

# flags to choose which data to backup and whether to back it up further with restic
export SCHEDULER_JOB_BACKUP_STATEFUL_DATA=true
export SCHEDULER_JOB_BACKUP_USER_DATA=true
export SCHEDULER_JOB_BACKUP_LOCAL_ENV_FILE=true
export SCHEDULER_JOB_STORE_WITH_RESTIC=true

export _SCHEDULER_JOB_BACKUP_STATEFUL_DATA_FILE='$([ "$SCHEDULER_JOB_BACKUP_STATEFUL_DATA" = "true" ] && echo "config-stateful.yml" || echo "../../blank.config.yml")'
export _SCHEDULER_JOB_BACKUP_USER_DATA_FILE='$([ "$SCHEDULER_JOB_BACKUP_USER_DATA" = "true" ] && echo "config-user.yml" || echo "../../blank.config.yml")'
export _SCHEDULER_JOB_BACKUP_LOCAL_ENV_FILE='$([ "$SCHEDULER_JOB_BACKUP_LOCAL_ENV_FILE" = "true" ] && echo "config-local-env.yml" || echo "blank.config.yml")'
export _SCHEDULER_JOB_STORE_WITH_RESTIC_FILE='$([ "$SCHEDULER_JOB_STORE_WITH_RESTIC" = "true" ] && echo "config-restic.yml" || echo "blank.config.yml")'

# volume used to temporarily store all backups locally before they can be moved to their final location
# Note: this must be a named volume (not a bind mount) due to limitations of the scheduler service
export SCHEDULER_JOB_BACKUP_VOLUME=birdhouse-external-backup

export SCHEDULER_JOB_BACKUP_LOG_FILE_EXTRAS='$([ -n "$BIRDHOUSE_LOG_FILE" ] && echo " --env BIRDHOUSE_LOG_FILE=\"${BIRDHOUSE_LOG_FILE}\" --volume\"${BIRDHOUSE_LOG_FILE}:${BIRDHOUSE_LOG_FILE}:rw\" ")'

# Common arguments used by many backup scheduler jobs (see the config/ directory in this folder for examples)
export SCHEDULER_JOB_BACKUP_COMMON_ARGS='
    --rm
    --volume /var/run/docker.sock:/var/run/docker.sock:ro
    --volume ${COMPOSE_DIR}/..:${COMPOSE_DIR}/..:rw
    --volume ${BIRDHOUSE_LOCAL_ENV}:${BIRDHOUSE_LOCAL_ENV}
    --env BIRDHOUSE_BACKWARD_COMPATIBLE_ALLOWED=${BIRDHOUSE_BACKWARD_COMPATIBLE_ALLOWED}
    --env BIRDHOUSE_LOCAL_ENV=${BIRDHOUSE_LOCAL_ENV}
    --env BIRDHOUSE_COMPOSE=${BIRDHOUSE_COMPOSE}
    --env BIRDHOUSE_LOG_LEVEL=${BIRDHOUSE_LOG_LEVEL}
    --env BIRDHOUSE_LOG_QUIET=${BIRDHOUSE_LOG_QUIET}
    --env BIRDHOUSE_COLOR=0
    ${SCHEDULER_JOB_BACKUP_LOG_FILE_EXTRAS}
'

# All backup jobs to extract data from the components should run at approximately the same time 
# so that they will all be finished before the final step that stores all backed up data to its 
# final location is run.
export SCHEDULER_JOB_BACKUP_EXTRACT_FREQUENCY='1 1 * * *' # at 1:01 am daily

# The job to send the backup to a stored location should be run well after the backup jobs that
# extract the data to backup from the components.
export SCHEDULER_JOB_BACKUP_STORE_FREQUENCY='5 5 * * *' # at 5:05 am daily

# Variable that stores the location of the birdhouse executable which is used in many scheduler jobs.
export SCHEDULER_JOB_BIRDHOUSE_EXE_LOC='${COMPOSE_DIR}/../bin/birdhouse'

export SCHEDULER_JOB_BACKUP_RESTIC_ENV_FILE='${COMPOSE_DIR}/restic.env'

DELAYED_EVAL="
  $DELAYED_EVAL
  SCHEDULER_JOB_BACKUP_LOG_FILE_EXTRAS
  SCHEDULER_JOB_BACKUP_COMMON_ARGS
  SCHEDULER_JOB_BIRDHOUSE_EXE_LOC
  SCHEDULER_JOB_BACKUP_COPY_FILE_IMAGE
  SCHEDULER_JOB_BACKUP_CURL_IMAGE
  SCHEDULER_JOB_BACKUP_DOCKER_IMAGE
  SCHEDULER_JOB_BACKUP_RESTIC_ENV_FILE
  _SCHEDULER_JOB_BACKUP_STATEFUL_DATA_FILE
  _SCHEDULER_JOB_BACKUP_USER_DATA_FILE
  _SCHEDULER_JOB_BACKUP_LOCAL_ENV_FILE
  _SCHEDULER_JOB_STORE_WITH_RESTIC_FILE
"

OPTIONAL_VARS="
  $OPTIONAL_VARS
  \$SCHEDULER_JOB_BACKUP_RESTIC_FORGET_ARGS
  \$SCHEDULER_JOB_BACKUP_RESTIC_BACKUP_ARGS
"

VARS="
  $VARS
  \$SCHEDULER_JOB_BACKUP_VOLUME
  \$SCHEDULER_JOB_BACKUP_DOCKER_IMAGE
  \$SCHEDULER_JOB_BACKUP_COMMON_ARGS
  \$SCHEDULER_JOB_BACKUP_EXTRACT_FREQUENCY
  \$SCHEDULER_JOB_BACKUP_STORE_FREQUENCY
  \$SCHEDULER_JOB_BIRDHOUSE_EXE_LOC
  \$SCHEDULER_JOB_BACKUP_COPY_FILE_IMAGE
  \$SCHEDULER_JOB_BACKUP_CURL_IMAGE
  \$SCHEDULER_JOB_BACKUP_RESTIC_IMAGE
  \$SCHEDULER_JOB_BACKUP_RESTIC_ENV_FILE
  \$SCHEDULER_JOB_BACKUP_PREFIX
"
