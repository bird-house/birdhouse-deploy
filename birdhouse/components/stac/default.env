# NOTE:
#   See also the following optional components that can be used in conjunction with this component to further
#   customize the data management, persistence and access mechanisms of the STAC API.
#
#   - birdhouse/optional-components/stac-data-proxy
#   - birdhouse/optional-components/stac-db-persist
#   - birdhouse/optional-components/stac-populator
#   - birdhouse/optional-components/stac-public-access

export STAC_POSTGRES_USER='${BIRDHOUSE_POSTGRES_USERNAME}'
export STAC_POSTGRES_PASSWORD='${BIRDHOUSE_POSTGRES_PASSWORD}'
export STAC_PGUSER='${BIRDHOUSE_POSTGRES_USERNAME}'
export STAC_PGPASSWORD='${BIRDHOUSE_POSTGRES_PASSWORD}'

# Following are the values that where applied by default for replicability:
#   crim-ca/stac-app:0.0.0 uses STAC-fastapi version 2.4.3 with pgstac 0.6.10 (technically <0.7)
#   crim-ca/stac-app:1.0.0 uses STAC-fastapi version 3.0.3 with pgstac 0.6.10 (techically >=0.7,<0.8, but 0.6 works)
#   crim-ca/stac-app:1.1.0 uses STAC-fastapi version 5.2.0 with pgstac 0.9.6 (techically >=0.8,<0.10)
#   crim-ca/stac-app:2.0.1 uses STAC-fastapi version 6.0.0 with pgstac 0.9.6+ (techically >=0.8,<0.10)
export STAC_VERSION=6.0.0-crim-2.0.2
export STAC_IMAGE='ghcr.io/crim-ca/stac-app:2.0.2'
export STAC_IMAGE_URI='${STAC_IMAGE}'
# database SQL schemas must be aligned with STAC_VERSION
# there versions are not "equal", check compatibilities on https://github.com/stac-utils/stac-fastapi-pgstac
export STAC_DB_VERSION=0.9.8
export STAC_DB_TAGGED='v${STAC_DB_VERSION}'
export STAC_DB_DOCKER='ghcr.io/stac-utils/pgstac'
export STAC_DB_IMAGE='${STAC_DB_DOCKER}:${STAC_DB_TAGGED}'
# The migration image allows update of the database schema to the latest version (patches).
# Note however that migration between different minor pgstac versions might not be automatically supported.
# This is because pgstac minor versions introduce PostGreSQL major versions updates, which requires manual intervention.
# In case major updates pose too much problems, consider using 'stac-populator' image with 'birdhouse backup' feature.
export STAC_MIGRATION_VERSION=0.9.8
export STAC_MIGRATION_TAGGED='v${STAC_MIGRATION_VERSION}'
export STAC_MIGRATION_DOCKER='${STAC_DB_DOCKER}-pypgstac'
export STAC_MIGRATION_IMAGE='${STAC_MIGRATION_DOCKER}:${STAC_MIGRATION_TAGGED}'

# for use with 'birdhouse backup create -r stac --no-restic' command
# this will extract the STAC Catalog, Collections and Items in plain JSON files under the backup volume
export STAC_POPULATOR_BACKUP_DOCKER=ghcr.io/crim-ca/stac-populator
export STAC_POPULATOR_BACKUP_VERSION=0.9.0
export STAC_POPULATOR_BACKUP_IMAGE='${STAC_POPULATOR_BACKUP_DOCKER}:${STAC_POPULATOR_BACKUP_VERSION}'

# When restoring representative data to the stac service, use this variable to set the STAC version used by the populator.
# This must match the "stac_version" value in the current STAC catalog.
export PYSTAC_STAC_VERSION_OVERRIDE=1.0.0

# Add additional origins that are allowed to access the /stac endpoint (other than the same origin) according to CORS rules. 
# The values in the space delimited list set by STAC_CORS_ORIGINS are origins that will be allowed to access responses
# from /stac. These values can either be strings which will be matched directly or regular expressions prefixed by ~.
#
# For example, if STAC_CORS_ORIGINS='https://example.com ~^https?://(www\.)?other\.example\.com$' then requests from
# https://example.com and http://other.example.com will get a response with the Access-Control-Allow-Origin header set
# to their origin, but http://example.ca will not.
export STAC_ADDITIONAL_CORS_ORIGINS='$(for origin in $STAC_CORS_ORIGINS; do echo "$origin \$http_origin;"; done;)'

# add any new variables not already in 'VARS' or 'OPTIONAL_VARS' that must be replaced in templates here
# single quotes are important in below list to keep variable names intact until 'birdhouse-compose' parses them
EXTRA_VARS='
  $STAC_POSTGRES_USER
  $STAC_POSTGRES_PASSWORD
  $STAC_PGUSER
  $STAC_PGPASSWORD
'
# extend the original 'VARS' from 'birdhouse/birdhouse-compose.sh' to employ them for template substitution
# adding them to 'VARS', they will also be validated in case of override of 'default.env' using 'env.local'
VARS="$VARS $EXTRA_VARS"

export DELAYED_EVAL="
  $DELAYED_EVAL
  STAC_POSTGRES_USER
  STAC_POSTGRES_PASSWORD
  STAC_PGUSER
  STAC_PGPASSWORD
  STAC_IMAGE
  STAC_IMAGE_URI
  STAC_DB_TAGGED
  STAC_DB_IMAGE
  STAC_MIGRATION_TAGGED
  STAC_MIGRATION_DOCKER
  STAC_MIGRATION_IMAGE
  STAC_POPULATOR_BACKUP_IMAGE
  STAC_ADDITIONAL_CORS_ORIGINS
"

OPTIONAL_VARS="
  $OPTIONAL_VARS
  \$STAC_VERSION
  \$STAC_IMAGE
  \$STAC_IMAGE_URI
  \$STAC_DB_VERSION
  \$STAC_DB_TAGGED
  \$STAC_DB_DOCKER
  \$STAC_DB_IMAGE
  \$STAC_MIGRATION_VERSION
  \$STAC_MIGRATION_TAGGED
  \$STAC_MIGRATION_DOCKER
  \$STAC_MIGRATION_IMAGE
  \$STAC_ADDITIONAL_CORS_ORIGINS
  \$STAC_CORS_ORIGIN_ALLOW_ALL
"
