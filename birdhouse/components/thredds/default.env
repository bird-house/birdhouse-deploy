# All env in this default.env can be overridden by env.local.

# thredds-docker >= 4.6.18 or >= 5.2 strongly recommended to avoid Log4J CVE-2021-44228.
export THREDDS_VERSION=4.6.18-unidata-2022-01
export THREDDS_DOCKER=pavics/thredds-docker
export THREDDS_IMAGE='${THREDDS_DOCKER}:${THREDDS_VERSION}'
export THREDDS_IMAGE_URI='registry.hub.docker.com/${THREDDS_IMAGE}'
export THREDDS_ORGANIZATION="Birdhouse"
export THREDDS_ADDITIONAL_CATALOG=""

export THREDDS_DATASET_LOCATION_ON_CONTAINER='/birdhouse-ncml'
export THREDDS_SERVICE_DATA_LOCATION_ON_CONTAINER='/birdhouse-data'
export THREDDS_DATASET_LOCATION_ON_HOST='${BIRDHOUSE_DATA_PERSIST_ROOT}/ncml'
export THREDDS_SERVICE_DATA_LOCATION_ON_HOST='${BIRDHOUSE_DATA_PERSIST_ROOT}/datasets'
export THREDDS_DATASET_LOCATION_NAME='Datasets'
export THREDDS_SERVICE_DATA_LOCATION_NAME='Birdhouse'
export THREDDS_DATASET_URL_PATH='datasets'
export THREDDS_SERVICE_DATA_URL_PATH='birdhouse'

export THREDDS_MAGPIE_EXTRA_METADATA_PREFIXES='".+\\.txt", ".+\\.md", ".+\\.rst"'
export THREDDS_MAGPIE_EXTRA_DATA_PREFIXES=''

export THREDDS_SERVICE_DATA_EXTRA_FILE_FILTERS=''

export THREDDS_DATASET_DATASETSCAN_BODY='
      <metadata inherited="true">
        <serviceName>all</serviceName>
      </metadata>

      <filter>
        <include wildcard="*.nc" />
        <include wildcard="*.ncml" />
        <include wildcard="*.txt" />
        <include wildcard="*.md" />
        <include wildcard="*.rst" />
        <include wildcard="*.csv" />
      </filter>
'

export PROMTAIL_VARLOGS_PIPELINE_STAGES="${PROMTAIL_VARLOGS_PIPELINE_STAGES}{match: {
      selector: '{filename=~\".*/proxy/${PROXY_LOG_FILE}\$\"}',
      stages: [
        {regex: {
          expression: '(?P<remote_addr>\S+)\s(?P<remote_usr>\S+)\s-\s\[(?P<date>\S+)T(?P<time>\S+)\+(?P<time_subsecond>\S+)\]\s\"(?P<req_method>\S+)\s(?P<req_uri>\S+)\s(?P<http_version>\S+)\"\s(?P<status>\S+)\s(?P<body_byte_sent>\S+)\s\"(?P<http_referer>[^\"]+)\"\s\"(?P<user_agent>[^\"]+)\"\s\"(?P<forward_for>[^\"]+)\"'
        }},
        {regex: {
          source: req_uri,
          expression: '/[^\s]+/thredds/(?P<tds_service>dodsC|fileServer|ncss)/(?P<dataset>[^\s]*)(?:\?(?P<variable>\w+))?'
        }},
        {drop: {
          source: tds_service,
          expression: "^$"
        }},
        {template: {
          source: body_byte_sent,
          template: '{{divf .Value 1024}}'
        }},
        {labels: {remote_addr: , date: , tds_service: , dataset: , variable: }},
        {labelallow: ["remote_addr", "date", "tds_service", "dataset", "variable"]},
        {metrics: {
          thredds_transfer_size_kb: {
            type: Counter,
            description: 'THREDDS data transferred',
            source: body_byte_sent,
            prefix: birdhouse_,
            config: {
              action: add
            }
          }
        }}
      ]
    }
  },"

# add any new variables not already in 'VARS' or 'OPTIONAL_VARS' that must be replaced in templates here
VARS="
  $VARS
  \$THREDDS_SERVICE_DATA_LOCATION_NAME
  \$THREDDS_SERVICE_DATA_URL_PATH
  \$THREDDS_SERVICE_DATA_LOCATION_ON_CONTAINER
  \$THREDDS_DATASET_LOCATION_NAME
  \$THREDDS_DATASET_URL_PATH
  \$THREDDS_DATASET_LOCATION_ON_CONTAINER
  \$THREDDS_DATASET_DATASETSCAN_BODY
"

OPTIONAL_VARS="
  $OPTIONAL_VARS
  \$THREDDS_ORGANIZATION
  \$TWITCHER_PROTECTED_PATH
  \$THREDDS_DOCKER
  \$THREDDS_VERSION
  \$THREDDS_IMAGE
  \$THREDDS_IMAGE_URI
  \$THREDDS_ADDITIONAL_CATALOG
  \$THREDDS_SERVICE_DATA_EXTRA_FILE_FILTERS
  \$THREDDS_MAGPIE_EXTRA_METADATA_PREFIXES
  \$THREDDS_MAGPIE_EXTRA_DATA_PREFIXES
"

export DELAYED_EVAL="
  $DELAYED_EVAL
  THREDDS_DATASET_LOCATION_ON_HOST
  THREDDS_SERVICE_DATA_LOCATION_ON_HOST
  THREDDS_IMAGE
  THREDDS_IMAGE_URI
"
