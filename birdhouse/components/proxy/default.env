# All env in this default.env can be overridden by env.local.

export PROXY_IMAGE="nginx:1.23.4"

# Timeout for reading a response from the proxied server.
# Any WPS processes taking longer than this should use async mode.
export PROXY_READ_TIMEOUT_VALUE="240s"

# CORS settings for the proxy to control which origins are allowed to access the service endpoints.
# Set to "*" to allow all origins by default.
# If explicitly set to empty string or omitted, it will also employ "*" by default.
# If you want to restrict access, set this to the space-delimited allowed domain(s).
# Can use other variables if needed (e.g.: '${BIRDHOUSE_PROXY_SCHEME}://${BIRDHOUSE_FQDN_PUBLIC}').
# Consider that adjusting this parameter could require other CORS-related settings to be adjusted as well
# for specific components, such as the 'STAC_CORS_ORIGINS' variable for STAC. Refer to its documentation for details.
export BIRDHOUSE_PROXY_CORS_ALLOW_ORIGIN="*"

export BIRDHOUSE_HTTP_ONLY="False"
export BIRDHOUSE_PROXY_SCHEME='$([ x"$BIRDHOUSE_HTTP_ONLY" = x"True" ] && echo http || echo https )'
export BIRDHOUSE_ALLOW_UNSECURE_HTTP='$([ x"$BIRDHOUSE_HTTP_ONLY" = x"True" ] && echo True || echo )'
export PROXY_INCLUDE_HTTPS='$([ x"$BIRDHOUSE_HTTP_ONLY" = x"True" ] || echo "include /etc/nginx/conf.d/https.include;" )'

# Content of "location /" in file config/proxy/conf.d/all-services.include.template
# Useful to have a custom homepage.
# Note that the default homepage will become the jupyterhub login page if the jupyterhub component is enabled.
# If the jupyterhub component is not enabled, it is highly recommended to create a custom homepage since the magpie
# landing page is not the most user-friendly option.
export BIRDHOUSE_PROXY_ROOT_LOCATION='return 302 ${BIRDHOUSE_PROXY_SCHEME}://\$host/jupyter/hub/login;'

export PROXY_INCLUDE_FOR_PORT_80='$([ x"$BIRDHOUSE_ALLOW_UNSECURE_HTTP" = x"True" ] && echo "include /etc/nginx/conf.d/all-services.include;" || echo "include /etc/nginx/conf.d/redirect-to-https.include;")'

# List of possible parameters for Nginx listen directive:
# https://nginx.org/en/docs/http/ngx_http_core_module.html#listen
# One useful param is "http2" to enable HTTP/2 protocol.
export PROXY_LISTEN_443_PARAMS=""
export PROXY_LISTEN_80_PARAMS=""


export DELAYED_EVAL="
  $DELAYED_EVAL
  BIRDHOUSE_PROXY_SCHEME
  BIRDHOUSE_ALLOW_UNSECURE_HTTP
  PROXY_INCLUDE_HTTPS
  PROXY_INCLUDE_FOR_PORT_80
  BIRDHOUSE_PROXY_ROOT_LOCATION
  BIRDHOUSE_PROXY_CORS_ALLOW_ORIGIN
"

# add any new variables not already in 'VARS' or 'OPTIONAL_VARS' that must be replaced in templates here
export VARS="
  $VARS
  \$BIRDHOUSE_DEPLOY_COMPONENTS_JSON
  \$BIRDHOUSE_DEPLOY_SERVICES_JSON
  \$BIRDHOUSE_VERSION_JSON
  \$BIRDHOUSE_PROXY_SCHEME
  \$BIRDHOUSE_PROXY_CORS_ALLOW_ORIGIN
"

export OPTIONAL_VARS="
  $OPTIONAL_VARS
  \$PROXY_INCLUDE_FOR_PORT_80
  \$PROXY_READ_TIMEOUT_VALUE
  \$BIRDHOUSE_PROXY_ROOT_LOCATION
  \$PROXY_INCLUDE_HTTPS
  \$PROXY_LISTEN_443_PARAMS
  \$PROXY_LISTEN_80_PARAMS
"
